#!/bin/sh

echo "Initial setup complete. Now doing post-up tasks."

# Automatically set --skip-worktree on gitconfig to prevent app modifications
# from showing up in git status. This is because ~/.gitconfig is symlinked and
# some apps (like Kaleidoscope, VSCode, etc.) auto-modify it.
#
# To commit intentional changes to gitconfig:
#   1. git update-index --no-skip-worktree gitconfig
#   2. Make your changes and commit
#   3. git update-index --skip-worktree gitconfig (or just run rcup again)
#
# Some IDEs may also allow you to stage directly without unskipping. But once
# you stage something, the whole file is unskipped again, so be careful.
(cd "$HOME/dotfiles" && git update-index --skip-worktree gitconfig 2>/dev/null)

if ! command -v brew &> /dev/null; then
  cat <<MSG >&2
Homebrew is not installed.
Try \`rcup' again after first installing Homebrew with

/bin/bash -c "\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"

MSG
fi

# reset -Q

# Add mise
if ! command -v mise &> /dev/null; then
  if ! command -v brew &> /dev/null; then
    echo "Cannot install mise without brew"
  else
    echo "Installing mise"
    brew install mise
  fi
fi

# detect old OS X broken /etc/zshenv and suggest rename
if grep -qw path_helper /etc/zshenv 2>/dev/null; then
  dir=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd -P)

  cat <<MSG >&2
Warning: \`/etc/zshenv' configuration file on your system may cause unexpected
PATH changes on subsequent invocations of the zsh shell. The solution is to
rename the file to \`zprofile':
  sudo mv /etc/{zshenv,zprofile}

(called from ${dir}/post-up:${LINENO})

MSG
fi
